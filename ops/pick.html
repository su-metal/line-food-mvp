<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>受取消込｜お得袋</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:0;padding:16px}
  .wrap{max-width:560px;margin:0 auto}
  .card{border:1px solid #eee;border-radius:12px;padding:16px}
  input{width:100%;font-size:18px;padding:12px;border:1px solid #ccc;border-radius:10px}
  button{width:100%;padding:12px;margin-top:12px;font-size:18px;border:0;border-radius:10px;background:#2b8a3e;color:#fff;cursor:pointer}
  .muted{color:#777;margin-top:8px}
  .ok{color:#2b8a3e;font-weight:600}
  .ng{color:#c92a2a;font-weight:600}
  #preview{width:100%;border-radius:12px;margin-top:12px;display:none}
  .row{display:flex;gap:8px;margin-top:8px}
  .ghost{background:#e9ecef;color:#222}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 12px 0">受取消込</h2>
  <div class="card">
    <div class="muted">お客様の受取コードを入力するか、QRをスキャンしてください。</div>
    <input id="code" placeholder="例：6P70V9" autocomplete="one-time-code" />
    <div class="row">
      <button id="btnConfirm">受取を確定する</button>
      <button id="btnScan" class="ghost">QRスキャン</button>
    </div>
    <video id="preview" playsinline></video>
    <div id="msg" class="muted"></div>
  </div>
</div>

<script>
const API_BASE = "https://line-food-mvp.vercel.app"; // ←あなたのAPIドメイン

async function pickup(code) {
  const btn = document.getElementById('btnConfirm');
  const msg = document.getElementById('msg');
  try{
    btn.disabled = true; btn.textContent = "送信中…"; msg.textContent = "";
    const r = await fetch(API_BASE + "/api/pickup", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ pickup_code: code })
    });
    const data = await r.json();
    if(data.ok){
      msg.innerHTML = `<span class="ok">受取を確定しました。</span>`;
      document.getElementById('code').value = "";
    }else{
      msg.innerHTML = `<span class="ng">エラー：${data.error||'invalid_or_used'}</span>`;
    }
  }catch(e){
    msg.innerHTML = `<span class="ng">通信エラー：${e.message}</span>`;
  }finally{
    btn.disabled = false; btn.textContent = "受取を確定する";
  }
}

document.getElementById('btnConfirm').addEventListener('click', ()=>{
  const c = document.getElementById('code').value.trim().toUpperCase();
  if(!c){ document.getElementById('msg').textContent = "コードを入力してください"; return;}
  pickup(c);
});
document.getElementById('code').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const c = e.target.value.trim().toUpperCase();
    if(c) pickup(c);
  }
});

// ---- QRスキャン（BarcodeDetector API / Fallback無しの軽量実装）----
const btnScan = document.getElementById('btnScan');
const video = document.getElementById('preview');
let stream=null, scanTimer=null, detector=null;

async function startScan(){
  try{
    if(!('BarcodeDetector' in window)){
      document.getElementById('msg').innerHTML = '<span class="ng">この端末はQRスキャンに未対応です（手入力をご利用ください）。</span>';
      return;
    }
    detector = new BarcodeDetector({ formats:['qr_code'] });
    stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'} });
    video.srcObject = stream;
    await video.play();
    video.style.display='block';
    loopScan();
  }catch(e){
    document.getElementById('msg').innerHTML = `<span class="ng">カメラ起動に失敗：${e.message}</span>`;
  }
}
async function loopScan(){
  if(!detector || video.readyState<2) { scanTimer = requestAnimationFrame(loopScan); return; }
  try{
    const codes = await detector.detect(video);
    if(codes && codes.length){
      const txt = codes[0].rawValue.trim().toUpperCase();
      stopScan();
      document.getElementById('code').value = txt;
      pickup(txt);
      return;
    }
  }catch(_){}
  scanTimer = requestAnimationFrame(loopScan);
}
function stopScan(){
  if(scanTimer) cancelAnimationFrame(scanTimer), scanTimer=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.pause(); video.srcObject=null; video.style.display='none';
}
btnScan.addEventListener('click', ()=>{
  if(stream) stopScan(); else startScan();
});
</script>
</body>
</html>
