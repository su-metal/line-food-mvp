<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>余剰食品ミニアプリ</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- QRコード生成用 (すでに利用している前提) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <style>
  /* ベース */
  body { font-family: sans-serif; margin: 16px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 10px 0; }
  .row { display: flex; justify-content: space-between; align-items: center; }
  .muted { color: #666; font-size: 0.9em; }
  button.primary { background:#28a745; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }

  /* 地図：モーダルより下に配置するため z-index を低く */
  #map { position: relative; z-index: 1; height: 400px; margin-top:16px; border:1px solid #ccc; border-radius:8px; }

  /* モーダル（QR用）を最前面へ */
  #modal{
    display:none;                   /* JSで .style.display='flex' にします */
    position:fixed;
    inset:0;                        /* top/right/bottom/left:0 の短縮 */
    background:rgba(0,0,0,.6);
    align-items:center;
    justify-content:center;
    z-index:10000;                  /* ← これが重要：最前面 */
  }

  /* モーダル表示中は背景スクロールを停止 */
  body.modal-open { overflow: hidden; }
  /* モーダルを絶対最前面へ & 表示中は地図をクリック不可に */
#modal { z-index: 2147483647 !important; }  /* 32bit上限級 */

body.modal-open #map,
body.modal-open .leaflet-container {
  pointer-events: none !important;          /* クリック抜け防止 */
}

/* Leaflet の各ペインが前面に来ないように、モーダル表示中だけ強制的に下げる */
body.modal-open .leaflet-pane,
body.modal-open .leaflet-top,
body.modal-open .leaflet-bottom {
  z-index: 0 !important;
}

</style>

</head>
<body>
  <h1>近くのお得袋</h1>
  <div id="friendStatus" class="muted" style="margin:8px 0;"></div>
<button id="friendCheckBtn" class="primary" style="margin-bottom:12px;">友だち状態を確認</button>

  <div id="me"></div>
  <div id="notice" class="muted">読み込み中…</div>
  <div id="list"></div>
  <div id="map" style="height:400px; margin-top:16px;"></div>


  <!-- QRモーダル -->
  <div id="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:300px; text-align:center;">
      <canvas id="qr"></canvas>
      <div id="codeTxt" style="margin-top:8px; font-size:20px; font-weight:bold;"></div>
      <div id="pickupWindow" class="muted" style="margin:8px 0;"></div>
      <div style="margin-top:12px;">
        <button id="closeBtn">閉じる</button>
        <button id="saveBtn">保存</button>
      </div>
    </div>
  </div>

<script>
const CONFIG = {
  LIFF_ID: "2008020661-mYj1EELk",               // ←あなたのLIFF ID
  API_BASE: "https://line-food-mvp.vercel.app", // ←APIのドメイン
  SUPABASE_URL: "https://wpxkjwnfofqdmfukrnqm.supabase.co",     // ←差し替え
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweGtqd25mb2ZxZG1mdWtybnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MzQ0OTcsImV4cCI6MjA3MjExMDQ5N30.Aiiuba6dNu_7ZMSns_6D1atbsIs9_PwmLpbVEpgG1yY"     // ←差し替え
};

let g = { userId: null, pos: null };
let map;  // Leafletマップを保持

function haversine(a,b){
  const toRad = d => d*Math.PI/180;
  const R=6371;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const sa=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(sa)); // km
}

async function init(){
  await liff.init({ liffId: CONFIG.LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  const prof = await liff.getProfile();
  g.userId = prof.userId;
  document.getElementById('me').textContent = 'ログイン済み';

  try{
    const geo = await new Promise((ok, ng)=>navigator.geolocation.getCurrentPosition(ok, ng,{enableHighAccuracy:true, timeout:8000}));
    g.pos = { lat: geo.coords.latitude, lng: geo.coords.longitude };
    document.getElementById('notice').textContent = '近い順に表示中';
  }catch(e){
    g.pos = null;
    document.getElementById('notice').textContent = '位置情報が拒否されました（距離順は概算表示）';
  }
  await loadOffers();
}

async function loadOffers(){
  const url = new URL(CONFIG.SUPABASE_URL + '/rest/v1/offers');
  url.searchParams.set('select','id,title,price,qty_available,pickup_start,pickup_end,shops:shop_id(id,name,lat,lng,address)');
  url.searchParams.set('status','eq.active');
  url.searchParams.set('qty_available','gt.0');
  url.searchParams.set('order','created_at.desc');

  const r = await fetch(url, { headers: { apikey: CONFIG.SUPABASE_ANON_KEY, Authorization: 'Bearer '+CONFIG.SUPABASE_ANON_KEY }});
  const items = await r.json();

  const list = items.map(it => {
    const shop = it.shops;
    const dist = (g.pos && shop?.lat && shop?.lng) ? haversine(g.pos,{lat:shop.lat,lng:shop.lng}) : null;
    return {...it, shop, dist};
  }).sort((a,b)=>{
    if(a.dist==null && b.dist==null) return 0;
    if(a.dist==null) return 1;
    if(b.dist==null) return -1;
    return a.dist-b.dist;
  });

  render(list);
}

function fmtTime(s){
  const d = new Date(s);
  const h = String(d.getHours()).padStart(2,'0');
  const m = String(d.getMinutes()).padStart(2,'0');
  return `${h}:${m}`;
}

async function reserve(offer, btn){
  btn.disabled = true;
  btn.textContent = '予約中…';
  try{
    const r = await fetch(CONFIG.API_BASE + '/api/reserve', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ offer_id: offer.id, user_liff_id: g.userId })
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||'reserve_failed');

    showQR({
      code: data.reservation.pickup_code,
      shopName: offer.shops?.name || '店舗',
      windowText: `受取時間 ${fmtTime(offer.pickup_start)}–${fmtTime(offer.pickup_end)}`
    });

    await loadOffers();
  }catch(e){
    alert('予約に失敗しました：' + e.message);
  }finally{
    btn.disabled = false;
    btn.textContent = '予約する';
  }
}

function showQR({code, shopName, windowText}) {
  const modal = document.getElementById('modal');
  const canvas = document.getElementById('qr');
  const codeTxt = document.getElementById('codeTxt');
  const pick = document.getElementById('pickupWindow');

  // ★ 追加：モーダルを body 直下に移動（安全な最前面に）
  if (modal.parentElement !== document.body) {
    document.body.appendChild(modal);
  }

  QRCode.toCanvas(canvas, code, { width: 220, margin: 1 }, () => {});
  codeTxt.textContent = code;
  pick.textContent = windowText || '';

  modal.style.display = 'flex';
  document.body.classList.add('modal-open');

  const onClose = () => {
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    if (typeof map !== 'undefined' && map) setTimeout(() => map.invalidateSize(), 0);
  };

  document.getElementById('closeBtn').onclick = onClose;
  document.getElementById('saveBtn').onclick = () => {
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = `pickup_${code}.png`;
    a.click();
  };
  modal.onclick = (e) => { if (e.target === modal) onClose(); };
}



function render(list){
  const el = document.getElementById('list');
  el.innerHTML = '';
  if(list.length===0){
    el.innerHTML = '<div class="muted">現在、近くにお得袋はありません。</div>';
    return;
  }
  list.forEach(it=>{
    const shop = it.shop || it.shops;
    const dist = (it.dist!=null) ? `${it.dist.toFixed(1)}km` : '';
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="row">
        <div>
          <div style="font-weight:600">${shop?.name || '店舗'}</div>
          <div class="muted" style="font-size:12px;">${shop?.address || ''}</div>
        </div>
        <div class="muted">${dist}</div>
      </div>
      <div style="margin:8px 0 4px 0">${it.title}</div>
      <div class="row">
        <div><b>¥${it.price}</b> / 残り${it.qty_available}</div>
        <div class="muted">受取 ${fmtTime(it.pickup_start)}–${fmtTime(it.pickup_end)}</div>
      </div>
      <div style="margin-top:10px" class="row">
        <button class="primary">予約する</button>
      </div>`;
    div.querySelector('button').onclick = (ev)=> reserve(it, ev.target);
    el.appendChild(div);
  });

  renderMap(list); // ← マップ描画を追加
}

function renderMap(list) {
  if (!g.pos) return;

  if (!map) {
    map = L.map('map').setView([g.pos.lat, g.pos.lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([g.pos.lat, g.pos.lng]).addTo(map).bindPopup("現在地").openPopup();
  }

  // 既存マーカーをリセット（現在地は残す）
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && !layer.getPopup()?.getContent().includes("現在地")) {
      map.removeLayer(layer);
    }
  });

  list.forEach(it => {
    const shop = it.shop || it.shops;
    if (shop?.lat && shop?.lng) {
      L.marker([shop.lat, shop.lng]).addTo(map)
        .bindPopup(`<b>${shop.name}</b><br>${shop.address || ''}`);
    }
  });
}

// 公式アカウントのベーシックID（@を含める）
const BOT_BASIC_ID = "@862eqkrz"; // ←あなたのIDに変更可

async function checkFriendship() {
  try {
    const { friendFlag } = await liff.getFriendship(); // true=友だち, false=未追加
    const box = document.getElementById('friendStatus');
    if (friendFlag) {
      box.textContent = "公式アカウントは『友だち』になっています。";
    } else {
      box.innerHTML = `まだ友だちではありません。追加しますか？`;
      // 追加導線（外部ブラウザで友だち追加画面を開く）
      const go = confirm("友だち追加画面を開きますか？");
      if (go) liff.openWindow({ url: `https://line.me/R/ti/p/${BOT_BASIC_ID}`, external: true });
    }
  } catch (e) {
    // 連携できていない場合などはここに来ます
    document.getElementById('friendStatus').textContent =
      "友だち状態を取得できません（Mini App と Messaging API の関連付けを確認してください）";
    console.error(e);
  }
}

// ボタンで手動チェック
document.getElementById('friendCheckBtn').onclick = checkFriendship;

// 自動チェックしたい場合は init() 成功後に呼ぶ
// init() の最後に ↓ を1行足してもOK
// await checkFriendship();


init();
</script>
</body>
</html>
