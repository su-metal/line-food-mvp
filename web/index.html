<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>モッタイナ</title>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- QR生成（予約完了時） -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <!-- アプリ内リアルタイムQRスキャン -->
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script>
      if (window.QrScanner) {
        QrScanner.WORKER_PATH =
          "https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";
      }
    </script>

    <style>
      /* ベース */
      body {
        font-family: sans-serif;
        margin: 16px;
      }
      :root {
        --appbar-h: 56px;
        --btn-radius: 12px;
        /* ===== タブバーの被り対策：下マージンを常に確保 ===== */
        --tabbar-h: 80px; /* フォールバック値（JSで上書き） */
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 12px;
        margin: 10px 0;
      }
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .muted {
        color: #666;
        font-size: 0.9em;
      }
      button.primary {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
      }
      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .badge {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        vertical-align: middle;
      }
      .badge.soldout {
        background: #ddd;
        color: #555;
      }
      .badge.reserved {
        background: #2e7d32;
        color: #fff;
      }
      .badge.paid {
        background: #1e88e5;
        color: #fff;
      }
      button.danger {
        background: #cc3333;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
      }
      button.danger:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* 地図（常に表示） */
      #map {
        position: relative;
        z-index: 1;
        height: 400px;
        margin-top: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        min-height: 300px;
      }

      /* 予約QRモーダル（ライブスキャンより下に） */
      #modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 2147483646;
      }
      body.modal-open {
        overflow: hidden;
      }

      /* ライブスキャン（最前面） */
      .live-scan {
        display: none;
        position: fixed;
        inset: 0;
        background: #000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 2147483647 !important;
      }
      .live-scan.show {
        display: flex;
      }
      .live-scan video {
        max-width: 100%;
        max-height: 70vh;
        pointer-events: auto;
      }
      .live-scan .close-btn {
        margin-top: 12px;
        position: relative;
        z-index: 2147483647;
      }

      /* モーダル／ライブスキャン中は背景（地図等）をクリック不可に */
      body.modal-open #map,
      body.modal-open .leaflet-container,
      body.live-scan-open #map,
      body.live-scan-open .leaflet-container {
        pointer-events: none !important;
      }

      /* ===== Home UI（検索バー / 横スワイプ / タブバー） ===== */
      :root {
        --brand: #6b1a16; /* お好みで */
        --ink: #222;
        --muted: #666;
        --card: #fff;
        --bg: #f6f3ef;
      }
      body {
        background: var(--bg);
      }

      .page-title {
        margin: 6px 0 8px;
        font-size: 22px;
        line-height: 1.25;
        font-weight: 800;
        color: #222;
      }

      .searchbar {
        background: #fff;
        border: 1px solid #e5e2dd;
        border-radius: 12px; /* 999px → 12px */
        padding: 8px 10px; /* 10px 14px → 8px 10px */
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .searchbar input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 14px; /* 15px → 14px */
        background: transparent;
      }
      .searchbar svg {
        width: 18px;
        height: 18px;
      }

      .sec {
        margin: 16px 0 8px;
      }
      .sec-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 4px;
      }
      .sec-head h2 {
        font-size: 18px;
        margin: 0;
      }
      .sec-head a {
        color: var(--brand);
        font-size: 14px;
        text-decoration: none;
      }

      /* 横スワイプ（ライブラリ不要） */
      .carousel {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: 80%;
        gap: 12px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding: 6px 4px 18px;
      }
      .card-lg {
        position: relative;
        background: #000;
        color: #fff;
        border-radius: 16px;
        overflow: hidden;
        height: 220px;
        scroll-snap-align: start;
      }
      .card-lg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        opacity: 0.95;
      }
      .card-lg .overlay {
        position: absolute;
        inset: auto 0 0 0;
        padding: 12px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0) 0%,
          rgba(0, 0, 0, 0.65) 70%
        );
      }
      .card-lg .title {
        font-weight: 700;
        font-size: 16px;
        line-height: 1.2;
      }
      .card-lg .meta {
        display: flex;
        gap: 10px;
        font-size: 12px;
        opacity: 0.95;
        margin-top: 4px;
      }
      .card-lg .price {
        position: absolute;
        right: 10px;
        top: 10px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
        padding: 4px 8px;
        font-weight: 700;
      }

      /* 下部タブバー */
      .tabbar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        background: #fff;
        border-top: 1px solid #e5e2dd;
        display: flex;
        justify-content: space-around;
        padding: 8px calc(env(safe-area-inset-right, 0px))
          calc(8px + env(safe-area-inset-bottom, 0px))
          calc(env(safe-area-inset-left, 0px));
      }
      .tabbar button {
        background: none;
        border: none;
        padding: 6px 8px;
        color: #8a8278;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .tabbar button.active {
        color: var(--brand);
        font-weight: 700;
      }
      .tabbar svg {
        width: 22px;
        height: 22px;
      }

      /* ページ切替 */
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }
      /* 横並びボタン行 */
      .btn-row {
        display: flex;
        gap: 8px;
        margin: 8px 0 12px;
      }
      .btn-row > .primary,
      .btn-row > .secondary {
        flex: 1; /* 同じ幅で並べる */
        border-radius: var(--btn-radius) !important;
      }

      /* （任意）フラットなグレーの補助ボタン */
      button.secondary {
        background: #6c757d;
        color: #fff;
      }
      button.secondary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .page-title {
        margin: 6px 0 8px;
        font-size: 22px;
        font-weight: 800;
        color: #222;
      }

      /* 固定ヘッダー */
      .appbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--appbar-h);
        display: flex;
        align-items: center;
        padding: 8px 12px calc(8px + env(safe-area-inset-right, 0))
          calc(12px + env(safe-area-inset-left, 0));
        background: #fff;
        border-bottom: 1px solid #e5e2dd;
        z-index: 1800;
      }

      :root {
        /* ===== タブバーの被り対策：下マージンを常に確保 ===== */
        --tabbar-h: 80px; /* フォールバック値（JSで上書き） */
      }

      body,
      .page {
        padding-bottom: calc(
          var(--tabbar-h) + env(safe-area-inset-bottom, 0px)
        );
      }

      /* ヘッダー内の検索バー（小ぶり） */
      .appbar .searchbar {
        width: 100%;
        background: #f7f5f2; /* 少しトーンを落とす */
        border: 1px solid #e5e2dd;
        border-radius: 12px;
        padding: 8px 10px;
      }
      .appbar .searchbar input {
        font-size: 14px;
      }
      .appbar .searchbar svg {
        width: 18px;
        height: 18px;
      }

      /* コンテンツがヘッダーの下に潜らないように */
      body {
        padding-top: calc(var(--appbar-h) + env(safe-area-inset-top, 0) + 8px);
      }

      /* ====== マップ用ボトムシート（ホームと同じカードを使う） ====== */
      .map-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: calc(var(--tabbar-h) + 8px); /* タブバーのすぐ上に出す */
        padding: 0 12px;
        z-index: 2100; /* タブバー(2000)より前面、スキャン(2147483xxx)より背面 */
        display: none;
      }
      .map-sheet.show {
        display: block;
      }
      .map-sheet .handle {
        width: 40px;
        height: 4px;
        border-radius: 2px;
        background: #d0ccc7;
        margin: 6px auto 8px;
      }
      /* ホームの .card-lg をそのまま流用（幅いっぱい・影を追加） */
      .map-sheet .card-lg {
        width: 100%;
        height: 210px; /* 少し低めに */
        border-radius: 16px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
      }
      .map-fab {
        position: fixed;
        right: 16px;
        bottom: calc(var(--tabbar-h) + 96px); /* タブバーに被らない高さに */
        z-index: 2100; /* タブバー(2000)より前面・スキャンより背面 */
        border: none;
        border-radius: 999px;
        padding: 10px 14px;
        background: #1e88e5;
        color: #fff;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>

  <body>
    <header class="appbar">
      <div class="searchbar">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path
            d="M21 21l-3.8-3.8M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
            stroke="#8a8278"
            stroke-width="1.6"
            stroke-linecap="round"
          />
        </svg>
        <input id="q" placeholder="現在地・駅・店舗名などから探す" />
      </div>
    </header>

    <h1>近くのお店・お得情報</h1>
    <div id="friendStatus" class="muted" style="margin: 8px 0"></div>

    <div class="btn-row">
      <button id="friendCheckBtn" class="secondary">友達情報を確認</button>
      <button id="btn-scan" class="primary">店舗QRを読み取る</button>
      <input
        type="file"
        id="qr-file"
        accept="image/*"
        capture="environment"
        style="display: none"
      />
    </div>

    <div id="me"></div>
    <div id="notice" class="muted">読み込み中…</div>

    <!-- スキャン起動 -->

    <!-- ここからホームページ -->
    <main id="page-home" class="page active">
      <section class="sec">
        <div class="sec-head">
          <h2>現在地付近のお店</h2>
          <a id="more-near">もっと見る ›</a>
        </div>
        <div id="near-carousel" class="carousel"></div>
      </section>

      <section class="sec">
        <div class="sec-head">
          <h2>最近追加されたお店</h2>
          <a id="more-recent">もっと見る ›</a>
        </div>
        <div id="recent-carousel" class="carousel"></div>
      </section>
    </main>

    <!-- ここから「お店を探す」ページ（地図） -->
    <main id="page-discover" class="page">
      <div id="map" style="height: 58vh; border-radius: 12px"></div>
      <button id="fitMeBtn" class="map-fab">現在地と周辺</button>
      <!-- 追加：マップのピンをタップしたときに出すボトムシート -->
      <div id="mapSheet" class="map-sheet" aria-hidden="true"></div>
      <div style="margin: 12px 0">
        <button id="btn-scan-discover" class="primary" style="width: 100%">
          店舗QRを読み取る
        </button>
      </div>
    </main>

    <!-- 下部タブバー（どの位置でもOK：bodyの末尾が無難） -->
    <nav class="tabbar">
      <button data-page="home" class="active">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M3 10.5 12 4l9 6.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9.5Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
        </svg>
        <small>ホーム</small>
      </button>
      <button data-page="discover">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M21 21l-3.8-3.8M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
          />
        </svg>
        <small>お店を探す</small>
      </button>
      <button data-page="fav">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="m12 21-1.45-1.32C6 15.36 3 12.61 3 9.28 3 6.5 5.24 4.5 7.88 4.5c1.45 0 2.87.64 3.78 1.67A5.2 5.2 0 0 1 15.44 4.5C18.08 4.5 20.3 6.5 20.3 9.28c0 3.33-3 6.08-7.55 10.4L12 21Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
        </svg>
        <small>お気に入り</small>
      </button>
      <button id="nav-scan">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M4 7V4h3M20 7V4h-3M4 17v3h3M20 17v3h-3M6 10h12v4H6z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <small>レスキュー</small>
      </button>
      <button data-page="me">
        <svg viewBox="0 0 24 24" fill="none">
          <path
            d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm8 9a8 8 0 1 0-16 0"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
          />
        </svg>
        <small>マイページ</small>
      </button>
    </nav>

    <!-- 予約QRモーダル -->
    <div id="modal" aria-hidden="true">
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 12px;
          max-width: 300px;
          text-align: center;
        "
      >
        <canvas id="qr"></canvas>
        <div
          id="codeTxt"
          style="margin-top: 8px; font-size: 20px; font-weight: bold"
        ></div>
        <div id="pickupWindow" class="muted" style="margin: 8px 0"></div>
        <div style="margin-top: 12px">
          <button id="closeBtn" class="primary" style="background: #666">
            閉じる
          </button>
          <button id="saveBtn" class="primary">保存</button>
          <button id="cancelBtn" class="danger">キャンセル</button>
        </div>
      </div>
    </div>

    <!-- ライブスキャンのオーバーレイ（最前面） -->
    <div id="liveScan" class="live-scan" aria-hidden="true">
      <video id="qrVideo" playsinline></video>
      <button
        id="scanClose"
        class="primary close-btn"
        onclick="closeLiveScan()"
      >
        閉じる
      </button>
    </div>

    <script>
      /* ============== 設定 ============== */
      const CONFIG = {
        LIFF_ID: "2008020661-mYj1EELk",
        API_BASE: "https://line-food-mvp.vercel.app",
        SUPABASE_URL: "https://wpxkjwnfofqdmfukrnqm.supabase.co",
        SUPABASE_ANON_KEY:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweGtqd25mb2ZxZG1mdWtybnFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MzQ0OTcsImV4cCI6MjA3MjExMDQ5N30.Aiiuba6dNu_7ZMSns_6D1atbsIs9_PwmLpbVEpgG1yY",
      };
      const BOT_BASIC_ID = "@862eqkrz";

      /* ============== 状態 ============== */
      let g = { userId: null, pos: null };
      let map, userMarker; // ← 追加：現在地の円マーカー用
      let mapAutoFitDone = false; // ← 追加：自動フィットは初回/強制時のみ
      var liveScanner = typeof liveScanner === "undefined" ? null : liveScanner; // 冪等宣言

      /* ============== ユーティリティ ============== */
      function haversine(a, b) {
        const toRad = (d) => (d * Math.PI) / 180,
          R = 6371;
        const dLat = toRad(b.lat - a.lat),
          dLng = toRad(b.lng - a.lng);
        const sa =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(a.lat)) *
            Math.cos(toRad(b.lat)) *
            Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(sa));
      }
      function fmtTime(s) {
        const d = new Date(s),
          h = String(d.getHours()).padStart(2, "0"),
          m = String(d.getMinutes()).padStart(2, "0");
        return `${h}:${m}`;
      }
      function parseShopId(v) {
        try {
          const s = String(v);
          const m = s.match(/^shop:(\d+)$/);
          if (m) return Number(m[1]);
          const o = JSON.parse(s);
          if (o && o.shop_id) return Number(o.shop_id);
        } catch {}
        return null;
      }

      /* ============== 初期化 ============== */
      async function init() {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const prof = await liff.getProfile();
        g.userId = prof.userId;
        document.getElementById("me").textContent = "ログイン済み";

        try {
          const geo = await new Promise((ok, ng) =>
            navigator.geolocation.getCurrentPosition(ok, ng, {
              enableHighAccuracy: true,
              timeout: 8000,
            })
          );
          g.pos = { lat: geo.coords.latitude, lng: geo.coords.longitude };
          document.getElementById("notice").textContent = "近い順に表示中";
        } catch {
          g.pos = null;
          document.getElementById("notice").textContent =
            "位置情報が拒否されました（距離順は概算表示）";
        }

        await loadMyReservations();
        await loadOffers();
      }

      async function loadOffers() {
        const url = new URL(CONFIG.SUPABASE_URL + "/rest/v1/offers");
        url.searchParams.set(
          "select",
          "id,title,price,qty_available,pickup_start,pickup_end,shops:shop_id(id,name,lat,lng,address)"
        );
        url.searchParams.set("status", "eq.active");
        // url.searchParams.set('qty_available','gt.0');
        url.searchParams.set("order", "created_at.desc");

        const r = await fetch(url, {
          headers: {
            apikey: CONFIG.SUPABASE_ANON_KEY,
            Authorization: "Bearer " + CONFIG.SUPABASE_ANON_KEY,
          },
        });
        const items = await r.json();

        const list = items
          .map((it) => {
            const shop = it.shops;
            const dist =
              g.pos && shop?.lat && shop?.lng
                ? haversine(g.pos, { lat: shop.lat, lng: shop.lng })
                : null;
            return { ...it, shop, dist };
          })
          .sort((a, b) => {
            if (a.dist == null && b.dist == null) return 0;
            if (a.dist == null) return 1;
            if (b.dist == null) return -1;
            return a.dist - b.dist;
          });
        window.__lastOffers = list; // 検索バーのフィルタで再利用
        render(list);
      }

      /* ============== 友だち確認 ============== */
      async function ensureFriend() {
        try {
          const { friendFlag } = await liff.getFriendship();
          if (friendFlag) return true;
          const go = confirm(
            "公式アカウントを友だち追加してください。追加画面を開きますか？"
          );
          if (go)
            liff.openWindow({
              url: `https://line.me/R/ti/p/${BOT_BASIC_ID}`,
              external: true,
            });
          return false;
        } catch {
          alert(
            "友だち状態を確認できませんでした。後でもう一度お試しください。"
          );
          return false;
        }
      }
      async function checkFriendship() {
        try {
          const { friendFlag } = await liff.getFriendship();
          document.getElementById("friendStatus").textContent = friendFlag
            ? "公式アカウントは『友だち』になっています。"
            : "まだ友だちではありません。";
        } catch (e) {
          document.getElementById("friendStatus").textContent =
            "友だち状態を取得できません（Mini App と Messaging API の関連付けを確認してください）";
          console.error(e);
        }
      }

      /* ============== 予約 & モーダル ============== */
      async function reserve(offer, btn) {
        if (offer.qty_available <= 0) {
          const ok = confirm(
            "この商品は在庫0です。サーバ側の sold_out 動作テストとして予約リクエストを送りますか？"
          );
          if (!ok) return;
        }
        if (!(await ensureFriend())) return;

        btn.disabled = true;
        const prev = btn.textContent;
        btn.textContent = "予約中…";
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/reserve", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + idToken,
            },
            body: JSON.stringify({ offer_id: offer.id }), // UUIDを送る
          });
          const data = await r.json();

          if (!data.ok) {
            if (data.error === "already_reserved")
              return alert("このお得袋はすでに予約済みです。");
            if (data.error === "sold_out_or_missing")
              return alert("在庫切れ、または見つかりませんでした。");
            throw new Error(data.error || "reserve_failed");
          }

          // 予約は作れたので、状態だけ更新（ここではQRは表示しない）
          myActive.set(offer.id, {
            id: data.reservation.id,
            status: "reserved",
            pickup_code: data.reservation.pickup_code || null,
          });

          alert("予約を作成しました。続けて「決済へ進む」を押してください。");
          await loadMyReservations();
          await loadOffers();
        } catch (e) {
          alert("予約に失敗しました：" + e.message);
        } finally {
          btn.disabled = false;
          btn.textContent = prev;
        }
      }

      function showQR({ code, reservationId, shopName, windowText }) {
        const modal = document.getElementById("modal");
        const canvas = document.getElementById("qr");
        const codeTxt = document.getElementById("codeTxt");
        const pick = document.getElementById("pickupWindow");

        if (modal.parentElement !== document.body)
          document.body.appendChild(modal);

        QRCode.toCanvas(canvas, code, { width: 220, margin: 1 }, () => {});
        codeTxt.textContent = code;
        pick.textContent = windowText || "";

        modal.style.display = "flex";
        document.body.classList.add("modal-open");

        const onClose = () => {
          modal.style.display = "none";
          document.body.classList.remove("modal-open");
          if (map) setTimeout(() => map.invalidateSize(), 0);
        };
        document.getElementById("closeBtn").onclick = onClose;
        document.getElementById("saveBtn").onclick = () => {
          const a = document.createElement("a");
          a.href = canvas.toDataURL("image/png");
          a.download = `pickup_${code}.png`;
          a.click();
        };
        const cancelBtn = document.getElementById("cancelBtn");
        if (cancelBtn)
          cancelBtn.onclick = () => cancelReservation(reservationId, onClose);
        modal.onclick = (e) => {
          if (e.target === modal) onClose();
        };
      }

      async function payReservation(reservationId, offer) {
        const idToken = liff.getIDToken();
        const r = await fetch(CONFIG.API_BASE + "/api/pay/fake-complete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + idToken,
          },
          body: JSON.stringify({ reservation_id: reservationId }),
        });
        const j = await r.json().catch(() => null);
        if (!r.ok || !j?.ok) {
          const msg = j?.error || "pay_failed";
          alert("決済（テスト）に失敗しました：" + msg);
          throw new Error(msg);
        }

        // RPCが返してくる予約情報で状態を更新
        const resv = j.reservation;
        myActive.set(resv.offer_id, {
          id: resv.id,
          status: "paid",
          pickup_code:
            resv.pickup_code ||
            myActive.get(resv.offer_id)?.pickup_code ||
            null,
        });

        // ここで QR を表示（ユーザーの希望フロー）
        showQR({
          code: myActive.get(resv.offer_id)?.pickup_code || resv.pickup_code,
          reservationId: resv.id,
          shopName: offer?.shops?.name || "店舗",
          windowText: `受取時間 ${fmtTime(offer.pickup_start)}–${fmtTime(
            offer.pickup_end
          )}`,
        });

        await loadMyReservations();
        await loadOffers();
      }

      async function cancelReservation(reservationId, onClose) {
        if (!reservationId) return alert("予約IDが見つかりません");
        if (!confirm("この予約をキャンセルしますか？")) return;
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/cancel", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + idToken,
            },
            body: JSON.stringify({ reservation_id: reservationId }),
          });
          let data;
          try {
            data = await r.json();
          } catch {}
          if (!r.ok || !data?.ok) {
            const msg = data?.error || "cancel_failed";
            if (msg === "too_late")
              return alert("受取開始後はキャンセルできません。");
            if (msg === "not_cancellable")
              return alert("この予約はキャンセルできません。");
            return alert("キャンセルに失敗しました：" + msg);
          }
          alert("キャンセルしました。");
          if (typeof onClose === "function") onClose();
          await loadOffers(); // 在庫を戻して再描画
        } catch (e) {
          alert("キャンセルに失敗しました：" + e.message);
        }
      }

      /* ============== 一覧 & 地図 ============== */
      function render(list) {
        // 新ホームUI（横スワイプ）の描画
        renderHomeSections(list);

        // 旧リストUIが無い環境では安全にスキップ
        const el = document.getElementById("list");
        if (el) {
          el.innerHTML = "";
          if (list.length === 0) {
            el.innerHTML =
              '<div class="muted">現在、近くにお得袋はありません。</div>';
          } else {
            list.forEach((it) => {
              const shop = it.shop || it.shops;
              const dist = it.dist != null ? `${it.dist.toFixed(1)}km` : "";
              const isSoldOut = it.qty_available <= 0;
              const my = myActive.get(it.id);
              const isPaid = my && my.status === "paid";

              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <div class="row">
                  <div>
                    <div style="font-weight:600">${shop?.name || "店舗"}</div>
                    <div class="muted" style="font-size:12px;">${
                      shop?.address || ""
                    }</div>
                  </div>
                  <div class="muted">${dist}</div>
                </div>
                <div style="margin:8px 0 4px 0">
                  ${it.title}
                  ${
                    isSoldOut && !my
                      ? '<span class="badge soldout">売切れ</span>'
                      : ""
                  }
                  ${my ? '<span class="badge reserved">予約済み</span>' : ""}
                  ${isPaid ? '<span class="badge paid">決済済み</span>' : ""}
                </div>
                <div class="row">
                  <div><b>¥${it.price}</b> / 残り${it.qty_available}</div>
                  <div class="muted">受取 ${fmtTime(it.pickup_start)}–${fmtTime(
                it.pickup_end
              )}</div>
                </div>
                <div style="margin-top:10px" class="row">
                  ${
                    my
                      ? isPaid
                        ? `<div><button class="primary btn-show-qr">QRを表示</button><button class="danger btn-cancel" disabled>キャンセル</button></div>`
                        : `<div><button class="primary btn-pay">決済へ進む（テスト）</button><button class="danger btn-cancel">キャンセル</button></div>`
                      : `<div><button class="primary btn-reserve" ${
                          isSoldOut ? "disabled" : ""
                        }>${
                          isSoldOut ? "在庫なし" : "予約へ進む"
                        }</button></div>`
                  }
                </div>`;
              // 必要ならここに各ボタンの addEventListener を付与
              el.appendChild(div);
            });
          }
        }

        // ★ 重要：必ず地図を更新
        renderMap(list);
      }

      function imgFor(it) {
        // 画像URLの候補（なければプレースホルダ）
        return (
          it.image_url ||
          it.shops?.image_url ||
          `https://placehold.co/800x600/j5b09d/ffffff?text=${encodeURIComponent(
            it.shops?.name || "Shop"
          )}`
        );
      }

      function buildCardHTML(it) {
        const shop = it.shop || it.shops;
        const time = `${fmtTime(it.pickup_start)}–${fmtTime(it.pickup_end)}`;
        const dist = it.dist != null ? `${it.dist.toFixed(1)}km` : "";
        const sold = it.qty_available <= 0;
        return `
        <article class="card-lg" data-offer="${it.id}">
          <img src="${imgFor(it)}" alt="">
          <div class="price">¥${it.price}</div>
          <div class="overlay">
            <div class="title">${shop?.name || "店舗"}</div>
            <div class="meta">
              <span>のこり${it.qty_available}</span>
              <span>${time}</span>
              <span>${dist}</span>
            </div>
            <div style="margin-top:8px">
              <button class="primary btn-resv" ${sold ? "disabled" : ""}>${
          sold ? "在庫なし" : "予約へ進む"
        }</button>
            </div>
          </div>
        </article>`;
      }

      function renderHomeSections(list) {
        // 近い順 / 最近追加
        const near = [...list]
          .sort((a, b) => {
            if (a.dist == null && b.dist == null) return 0;
            if (a.dist == null) return 1;
            if (b.dist == null) return -1;
            return a.dist - b.dist;
          })
          .slice(0, 12);

        const recent = [...list].slice(0, 12); // APIで created_at.desc にしている想定

        const nearEl = document.getElementById("near-carousel");
        const recEl = document.getElementById("recent-carousel");
        nearEl.innerHTML = near.map(buildCardHTML).join("");
        recEl.innerHTML = recent.map(buildCardHTML).join("");

        // 各カードのボタンにイベント付与
        [
          ...nearEl.querySelectorAll(".card-lg"),
          ...recEl.querySelectorAll(".card-lg"),
        ].forEach((card) => {
          const id = card.getAttribute("data-offer");
          const offer = list.find((x) => x.id === id);
          card
            .querySelector(".btn-resv")
            ?.addEventListener("click", (ev) => reserve(offer, ev.target));
        });
      }
      // ヘルパー関数
      function isMapVisible() {
        const el = document.getElementById("map");
        if (!el) return false;
        const cs = getComputedStyle(el);
        const rect = el.getBoundingClientRect();
        return (
          cs.display !== "none" &&
          cs.visibility !== "hidden" &&
          rect.width > 0 &&
          rect.height > 0
        );
      }

      function fitToUserAndNearest(list, force = false) {
        if (!map) return;

        // 近い順に並んだ offers（render前に list を受け取る想定）
        const shops = (list || []).filter(
          (it) => it?.shops?.lat && it?.shops?.lng
        );

        // 現在地 + 近い店舗 最大6件 をフィット対象に
        const targets = [];
        if (g.pos) targets.push(L.latLng(g.pos.lat, g.pos.lng));

        const sorted = g.pos
          ? [...shops].sort(
              (a, b) => (a.dist ?? Infinity) - (b.dist ?? Infinity)
            )
          : shops;
        sorted.slice(0, Math.min(6, sorted.length)).forEach((it) => {
          targets.push(L.latLng(it.shops.lat, it.shops.lng));
        });

        if (!targets.length) return;

        // 初回 or 強制時のみフィット（ユーザーの手動操作を尊重）
        if (!mapAutoFitDone || force) {
          const bounds = L.latLngBounds(targets);
          map.fitBounds(bounds, { padding: [30, 30], maxZoom: 14 });
          mapAutoFitDone = true;
        }
      }

      function renderMap(list) {
        if (!map) {
          map = L.map("map", { zoomControl: true }).setView(
            [35.6812, 139.7671],
            12
          );
          window.map = map; // ← 追加：以後のチェックが動くように

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(map);

          setTimeout(() => {
            try {
              map.invalidateSize();
            } catch {}
          }, 0);
        }

        // 既存マーカー削除（タイルは残す）
        const remove = [];
        map.eachLayer((l) => {
          if (l instanceof L.Marker) remove.push(l);
        });
        remove.forEach((l) => map.removeLayer(l));

        const markers = [];

        // 現在地は「円マーカー」で色を変える（店舗とは見分けやすく）
        if (g.pos) {
          if (!userMarker) {
            userMarker = L.circleMarker([g.pos.lat, g.pos.lng], {
              radius: 10,
              color: "#2e7d32", // 枠線色（濃い緑）
              fillColor: "#66bb6a", // 塗り色（明るい緑）
              fillOpacity: 0.9,
              weight: 3,
            })
              .addTo(map)
              .bindPopup("現在地");
          } else {
            userMarker.setLatLng([g.pos.lat, g.pos.lng]);
          }
          markers.push(userMarker);
        }

        list.forEach((it) => {
          const s = it.shop || it.shops;
          if (s?.lat && s?.lng) {
            const marker = L.marker([s.lat, s.lng]).addTo(map);
            marker.on("click", () => {
              // この it（＝オファー）でホームと同じカードを下から表示
              showMapSheet(it);
            });
          }
        });

        // マップの適当な場所をタップ/ドラッグしたら閉じる
        map.off("click", hideMapSheet); // 多重登録防止
        map.off("movestart", hideMapSheet);
        map.on("click", hideMapSheet);
        map.on("movestart", hideMapSheet);

        // 店舗だけの座標を集める（現在地は含めない）
        const shopLatLngs = list
          .map((it) => it.shop || it.shops)
          .filter((s) => s?.lat && s?.lng)
          .map((s) => [s.lat, s.lng]);

        const mapEl = document.getElementById("map");
        const hidden =
          !mapEl ||
          mapEl.offsetWidth === 0 ||
          getComputedStyle(mapEl).display === "none";
        if (hidden) {
          mapAutoFitDone = false;
          return;
        }

        // 地図が見えていない時にfitするとズレるので抑止
        if (!mapAutoFitDone && isMapVisible()) {
          const targets = [];
          // ...現在地と店舗をtargetsに詰める（今のロジックのまま）...
          if (targets.length >= 2) {
            const bounds = L.latLngBounds(targets);
            map.fitBounds(bounds, { padding: [30, 30], maxZoom: 14 });
          } else if (targets.length === 1) {
            map.setView(targets[0], 13);
          } else {
            map.setView([35.6812, 139.7671], 11);
          }
          mapAutoFitDone = true;
        }
      }

      // ===== マップ用ボトムシート：ホームのカードをそのまま使う =====
      const mapSheetEl = document.getElementById("mapSheet");

      function hideMapSheet() {
        if (!mapSheetEl) return;
        mapSheetEl.classList.remove("show");
        mapSheetEl.innerHTML = "";
      }

      function showMapSheet(offer) {
        if (!mapSheetEl) return;
        // ホームで使っている buildCardHTML(offer) を流用
        const html = `
          <div class="handle"></div>
          ${buildCardHTML(offer)}
        `;
        mapSheetEl.innerHTML = html;
        mapSheetEl.classList.add("show");

        // カード内ボタン（予約へ進む）にイベントを割り当て
        const btn = mapSheetEl.querySelector(".btn-resv");
        if (btn)
          btn.addEventListener("click", (ev) => reserve(offer, ev.target));
      }

      /* ============== ライブスキャン ============== */
      async function favPost(shopId) {
        const idToken = liff.getIDToken();
        const res = await fetch(`${CONFIG.API_BASE}/api/favorite-add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + idToken,
          },
          body: JSON.stringify({ shop_id: shopId }),
        });
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || "favorite_failed");
      }

      function scanByImage() {
        const inp = document.getElementById("qr-file");
        if (!inp) return alert("画像入力が見つかりません");
        inp.onchange = async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          try {
            const res = await QrScanner.scanImage(file);
            const text = res?.data || res;
            const shopId = parseShopId(text);
            if (!shopId) return alert("QRの形式が不正です");
            if (!(await ensureFriend())) return;
            await favPost(shopId);
            alert("お気に入り店舗に登録しました");
          } catch (err) {
            console.error(err);
            alert("画像からQRを読み取れませんでした");
          } finally {
            e.target.value = "";
          }
        };
        inp.click();
      }

      async function openLiveScan() {
        try {
          if (!(await ensureFriend())) return;

          const box = document.getElementById("liveScan");
          const video = document.getElementById("qrVideo");
          if (!box || !video)
            return alert("ライブスキャンの要素が見つかりません");

          // 表示 & 背景ロック
          box.classList.add("show");
          document.body.classList.add("live-scan-open");

          if (!window.QrScanner) {
            alert("スキャナを読み込めませんでした");
            return closeLiveScan();
          }

          // 多重起動ガード
          if (liveScanner) {
            try {
              await liveScanner.stop();
            } catch {}
            liveScanner.destroy();
            liveScanner = null;
          }

          liveScanner = new QrScanner(
            video,
            async (result) => {
              try {
                const text = result?.data || result;
                const shopId = parseShopId(text);
                if (!shopId) {
                  alert("QRの形式が不正です");
                  return;
                }
                await favPost(shopId);
                alert("お気に入り店舗に登録しました");
                closeLiveScan();
              } catch (e) {
                console.error(e);
                alert("処理に失敗しました");
              }
            },
            {
              preferredCamera: "environment",
              highlightScanRegion: true,
              highlightCodeOutline: true,
            }
          );

          await liveScanner.start();
        } catch (e) {
          console.error(e);
          const go = confirm(
            "カメラを起動できませんでした。画像から読み取りますか？"
          );
          if (go) scanByImage();
          closeLiveScan();
        }
      }

      async function closeLiveScan() {
        const box = document.getElementById("liveScan");
        box?.classList.remove("show");
        document.body.classList.remove("live-scan-open");
        if (liveScanner) {
          try {
            await liveScanner.stop();
          } catch {}
          liveScanner.destroy();
          liveScanner = null;
        }
      }

      let myActive = new Map(); // offer_id -> { id, status, pickup_code }

      async function loadMyReservations() {
        myActive.clear();
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(CONFIG.API_BASE + "/api/my-reservations", {
            headers: { Authorization: "Bearer " + idToken },
          });
          const j = await r.json();
          if (r.ok && j?.ok && Array.isArray(j.items)) {
            j.items.forEach((x) => {
              myActive.set(x.offer_id, {
                id: x.id,
                status: x.status,
                pickup_code: x.pickup_code || null,
              });
            });
          }
        } catch (e) {
          console.warn("loadMyReservations failed", e);
        }
      }

      /* ============== イベント登録 ============== */
      document.addEventListener("DOMContentLoaded", () => {
        // 既存：スキャン系のイベント
        document
          .getElementById("btn-scan")
          ?.addEventListener("click", openLiveScan);
        document
          .getElementById("scanClose")
          ?.addEventListener("click", closeLiveScan);
        document.getElementById("liveScan")?.addEventListener("click", (e) => {
          if (e.target && e.target.id === "liveScan") closeLiveScan();
        });
        document
          .getElementById("friendCheckBtn")
          ?.addEventListener("click", checkFriendship);

        // 追加：ページ切り替え用ヘルパー
        function showPage(name) {
          document
            .querySelectorAll(".page")
            .forEach((p) => p.classList.remove("active"));
          if (name === "home")
            document.getElementById("page-home")?.classList.add("active");
          if (name === "discover") {
            document.getElementById("page-discover")?.classList.add("active");
            // 次の描画で自動フィット可に
            mapAutoFitDone = false;

            setTimeout(() => {
              if (map) {
                map.invalidateSize(); // サイズ再計算
                // ★地図が可視になったタイミングで「現在地+近隣店」に強制フィット
                fitToUserAndNearest(window.__lastOffers || [], true);
              }
              updateTabbarInset();
            }, 120);
          }
          document
            .querySelectorAll(".tabbar button")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelector(`.tabbar button[data-page="${name}"]`)
            ?.classList.add("active");
        }

        // 追加：タブをタップしたらページを切り替え
        document
          .querySelectorAll(".tabbar button[data-page]")
          .forEach((btn) => {
            btn.addEventListener("click", () => showPage(btn.dataset.page));
          });

        // 追加：「レスキュー」タブはスキャン起動
        document
          .getElementById("nav-scan")
          ?.addEventListener("click", openLiveScan);

        // 追加：「もっと見る」は地図ページへ
        document
          .getElementById("more-near")
          ?.addEventListener("click", () => showPage("discover"));
        document
          .getElementById("more-recent")
          ?.addEventListener("click", () => showPage("discover"));

        document
          .getElementById("btn-scan")
          ?.addEventListener("click", openLiveScan);
        document
          .getElementById("btn-scan-discover")
          ?.addEventListener("click", openLiveScan);
        document
          .getElementById("fitMeBtn")
          ?.addEventListener("click", async () => {
            // 位置情報を取り直したい場合は以下の2行を有効化
            // try {
            //   const geo = await new Promise((ok, ng) => navigator.geolocation.getCurrentPosition(ok, ng, { enableHighAccuracy: true, timeout: 8000 }));
            //   g.pos = { lat: geo.coords.latitude, lng: geo.coords.longitude };
            // } catch {}
            fitToUserAndNearest(window.__lastOffers || [], true);
          });

        // （※ 検索バーのフィルタ (d) を入れているなら、ここに q の input リスナーも追記）
        const q = document.getElementById("q");
        if (q) {
          q.addEventListener("input", () => {
            const kw = q.value.trim().toLowerCase();
            if (!window.__lastOffers) return;
            const base = window.__lastOffers;
            const filtered = kw
              ? base.filter((it) => {
                  const shop = it.shop || it.shops;
                  return (
                    (it.title || "").toLowerCase().includes(kw) ||
                    (shop?.name || "").toLowerCase().includes(kw) ||
                    (shop?.address || "").toLowerCase().includes(kw)
                  );
                })
              : base;
            renderHomeSections(filtered);
          });
        }
      });

      init();
      function fixMapSize() {
        if (map)
          setTimeout(() => {
            try {
              map.invalidateSize();
            } catch {}
          }, 80);
      }
      window.addEventListener("load", fixMapSize);
      window.addEventListener("resize", fixMapSize);
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) fixMapSize();
      });

      // （タブ切替を実装している場合）ページ表示を切り替えた直後にも
      // showPage('discover') などで地図を表示にした直後に呼ぶと確実
      // 例：setTimeout(fixMapSize, 60);
      function updateTabbarInset() {
        const tb = document.querySelector(".tabbar");
        if (!tb) return;
        const h = Math.ceil(tb.getBoundingClientRect().height);
        // 端末のセーフエリア込みで高さが変わるので実寸をCSS変数に反映
        document.documentElement.style.setProperty("--tabbar-h", h + "px");
      }

      // 起動時・回転/リサイズ時・復帰時に更新
      window.addEventListener("load", updateTabbarInset);
      window.addEventListener("resize", updateTabbarInset);
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) updateTabbarInset();
      });

      // タブバーの高さが動的に変わっても追従
      if (window.ResizeObserver) {
        const tb = document.querySelector(".tabbar");
        if (tb) new ResizeObserver(updateTabbarInset).observe(tb);
      }
    </script>
  </body>
</html>
